"use strict";(self.webpackChunk_mapcomponents_react_maplibre=self.webpackChunk_mapcomponents_react_maplibre||[]).push([[7855],{"./src/components/MlThreeJsLayer/MlThreeJsLayer.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{ExampleConfig:()=>ExampleConfig,__namedExportsOrder:()=>__namedExportsOrder,default:()=>MlThreeJsLayer_stories});var react=__webpack_require__("./node_modules/react/index.js"),NoNavToolsDecorator=__webpack_require__("./src/decorators/NoNavToolsDecorator.tsx"),TopToolbar=__webpack_require__("./src/ui_components/TopToolbar.tsx"),Button=__webpack_require__("./node_modules/@mui/material/esm/Button/Button.js"),contexts_MapContext=__webpack_require__("./src/contexts/MapContext.tsx"),maplibre_gl=__webpack_require__("./node_modules/maplibre-gl/dist/maplibre-gl.js"),maplibre_gl_default=__webpack_require__.n(maplibre_gl),three_core=__webpack_require__("./node_modules/three/build/three.core.js"),three_module=__webpack_require__("./node_modules/three/build/three.module.js"),GLTFLoader=__webpack_require__("./node_modules/three/examples/jsm/loaders/GLTFLoader.js"),MlThreeJsLayer=function MlThreeJsLayer(props){var mapContext=(0,react.useContext)(contexts_MapContext.A),initializedRef=(0,react.useRef)(!1),mapRef=(0,react.useRef)(null),initFuncRef=(0,react.useRef)(props.init),cleanup=function cleanup(){mapRef.current&&mapRef.current.style&&(mapRef.current.getLayer("3d-model")&&mapRef.current.removeLayer("3d-model"),mapRef.current=null)};return(0,react.useEffect)((function(){return"function"==typeof initFuncRef.current&&initFuncRef.current(),cleanup}),[]),(0,react.useEffect)((function(){var _mapRef$current,_mapRef$current2,_mapRef$current3,_mapRef$current4,_mapRef$current5;if(mapContext.mapExists(props.mapId)&&!initializedRef.current){initializedRef.current=!0,mapRef.current=mapContext.getMap(props.mapId),null===(_mapRef$current=mapRef.current)||void 0===_mapRef$current||_mapRef$current.setCenter([7.099771581806502,50.73395746209983]),null===(_mapRef$current2=mapRef.current)||void 0===_mapRef$current2||_mapRef$current2.setZoom(15),null===(_mapRef$current3=mapRef.current)||void 0===_mapRef$current3||_mapRef$current3.setPitch(45);var modelRotate=[Math.PI/2,90,0],modelAsMercatorCoordinate=maplibre_gl_default().MercatorCoordinate.fromLngLat([7.099771581806502,50.73395746209983],0),modelTransform={translateX:modelAsMercatorCoordinate.x+8e-7,translateY:modelAsMercatorCoordinate.y+18e-7,translateZ:modelAsMercatorCoordinate.z,rotateX:modelRotate[0],rotateY:modelRotate[1],rotateZ:modelRotate[2],scale:modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()+3e-8},customLayer={id:"3d-model",type:"custom",renderingMode:"3d",camera:void 0,scene:void 0,onAdd:function onAdd(map,gl){var self=this;this.camera=new three_core.i7d,this.scene=new three_core.Z58;var directionalLight=new three_core.ZyN(16777215);directionalLight.position.set(0,-70,100).normalize(),this.scene.add(directionalLight);var directionalLight2=new three_core.ZyN(16777215);directionalLight2.position.set(0,70,100).normalize(),this.scene.add(directionalLight2),(new GLTFLoader.B).load("assets/3D/godzilla_simple.glb",function(gltf){var _self$scene;null===(_self$scene=self.scene)||void 0===_self$scene||_self$scene.add(gltf.scene),"function"==typeof props.onDone&&props.onDone()}.bind(this)),this.map=map,this.renderer=new three_module.JeP({canvas:map.getCanvas(),context:gl,antialias:!0}),this.renderer.autoClear=!1},render:function render(_gl,matrix){var rotationX=(new three_core.kn4).makeRotationAxis(new three_core.Pq0(1,0,0),modelTransform.rotateX),rotationY=(new three_core.kn4).makeRotationAxis(new three_core.Pq0(0,1,0),modelTransform.rotateY),rotationZ=(new three_core.kn4).makeRotationAxis(new three_core.Pq0(0,0,1),modelTransform.rotateZ),m=(new three_core.kn4).fromArray(Object.values(matrix.defaultProjectionData.mainMatrix)),l=(new three_core.kn4).makeTranslation(modelTransform.translateX,modelTransform.translateY,modelTransform.translateZ).scale(new three_core.Pq0(modelTransform.scale,-modelTransform.scale,modelTransform.scale)).multiply(rotationX).multiply(rotationY).multiply(rotationZ);this.camera&&this.scene&&(this.camera.projectionMatrix=m.multiply(l),this.renderer.resetState(),this.renderer.render(this.scene,this.camera),this.map.triggerRepaint())}};null===(_mapRef$current4=mapRef.current)||void 0===_mapRef$current4||_mapRef$current4.addLayer(customLayer),null!==(_mapRef$current5=mapRef.current)&&void 0!==_mapRef$current5&&_mapRef$current5.getLayer("3d-model")&&mapRef.current.setLayoutProperty("3d-model","visibility","visible")}}),[mapContext.mapIds,mapContext,props]),react.createElement(react.Fragment,null)};const MlThreeJsLayer_MlThreeJsLayer=MlThreeJsLayer;try{MlThreeJsLayer.displayName="MlThreeJsLayer",MlThreeJsLayer.__docgenInfo={description:"",displayName:"MlThreeJsLayer",props:{mapId:{defaultValue:null,description:"",name:"mapId",required:!1,type:{name:"string | undefined"}},init:{defaultValue:null,description:"",name:"init",required:!1,type:{name:"(() => void) | undefined"}},onDone:{defaultValue:null,description:"",name:"onDone",required:!1,type:{name:"(() => void) | undefined"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/MlThreeJsLayer/MlThreeJsLayer.tsx#MlThreeJsLayer"]={docgenInfo:MlThreeJsLayer.__docgenInfo,name:"MlThreeJsLayer",path:"src/components/MlThreeJsLayer/MlThreeJsLayer.tsx#MlThreeJsLayer"})}catch(__react_docgen_typescript_loader_error){}var src=__webpack_require__("./src/index.ts");function _slicedToArray(r,e){return function _arrayWithHoles(r){if(Array.isArray(r))return r}(r)||function _iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}(r,e)||function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}(r,e)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}var LoadingOverlayContext=react.createContext({}),LoadingOverlayContextProvider=LoadingOverlayContext.Provider,LoadingOverlayProvider=function LoadingOverlayProvider(children){var mapContext=useContext(MapContext),_useState2=_slicedToArray(useState(!1),2),controlled=_useState2[0],setControlled=_useState2[1],_useState4=_slicedToArray(useState(!1),2),loadingDone=_useState4[0],setLoadingDone=_useState4[1],_useState6=_slicedToArray(useState(!0),2),visible=_useState6[0],setVisible=_useState6[1],_useState8=_slicedToArray(useState(!1),2),fadeoutAnimation=_useState8[0],setFadeoutAnimation=_useState8[1],mapJobsRef=useRef({}),_useState0=_slicedToArray(useState(0),2),checkIdleTrigger=_useState0[0],setCheckIdleTrigger=_useState0[1],createOnMapIdleFunction=function createOnMapIdleFunction(mapId){return function(){mapJobsRef.current[mapId]=!0,setCheckIdleTrigger(Math.random())}},fadeOut=function fadeOut(){setTimeout((function(){setFadeoutAnimation(!0),setTimeout((function(){setVisible(!1)}),1700)}),900)};useEffect((function(){if(mapContext.map&&!controlled){for(var _key in mapJobsRef.current)if(!mapJobsRef.current[_key])return;fadeOut()}}),[checkIdleTrigger,controlled,mapContext]),useEffect((function(){for(var i=0,len=mapContext.mapIds.length;i<len;i++)if(-1===Object.keys(mapJobsRef.current).indexOf(mapContext.mapIds[i])){var mapId=mapContext.mapIds[i]+"";mapContext.getMap(mapId)&&(mapJobsRef.current[mapId]=!1,mapContext.getMap(mapId).on("idle",createOnMapIdleFunction(mapId)))}}),[mapContext,mapContext.mapIds]),useEffect((function(){loadingDone&&fadeOut()}),[loadingDone]);var value={setControlled,controlled,visible,fadeoutAnimation,setLoadingDone};return React.createElement(LoadingOverlayContextProvider,{value},children)};try{LoadingOverlayProvider.displayName="LoadingOverlayProvider",LoadingOverlayProvider.__docgenInfo={description:"",displayName:"LoadingOverlayProvider",props:{}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/ui_components/LoadingOverlayContext.tsx#LoadingOverlayProvider"]={docgenInfo:LoadingOverlayProvider.__docgenInfo,name:"LoadingOverlayProvider",path:"src/ui_components/LoadingOverlayContext.tsx#LoadingOverlayProvider"})}catch(__react_docgen_typescript_loader_error){}var MlNavigationTools=__webpack_require__("./src/components/MlNavigationTools/MlNavigationTools.tsx");function MlThreeJsLayer_stories_slicedToArray(r,e){return function MlThreeJsLayer_stories_arrayWithHoles(r){if(Array.isArray(r))return r}(r)||function MlThreeJsLayer_stories_iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}(r,e)||function MlThreeJsLayer_stories_unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return MlThreeJsLayer_stories_arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?MlThreeJsLayer_stories_arrayLikeToArray(r,a):void 0}}(r,e)||function MlThreeJsLayer_stories_nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function MlThreeJsLayer_stories_arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}const MlThreeJsLayer_stories={title:"MapComponents/MlThreeJsLayer",component:MlThreeJsLayer_MlThreeJsLayer,argTypes:{options:{control:{type:"object"}}},decorators:NoNavToolsDecorator.A};var ExampleConfig=function Template(){var _mapHook$map,_mapHook$map2,_useState2=MlThreeJsLayer_stories_slicedToArray((0,react.useState)(!0),2),showLayer=_useState2[0],setShowLayer=_useState2[1],showLayerRef=(0,react.useRef)(!0),loadingOverlayContext=LoadingOverlayContext,mapHook=(0,src.ko)();return null===(_mapHook$map=mapHook.map)||void 0===_mapHook$map||_mapHook$map.setZoom(14.5),null===(_mapHook$map2=mapHook.map)||void 0===_mapHook$map2||_mapHook$map2.setCenter([7.1,50.736]),react.createElement(react.Fragment,null,showLayer&&react.createElement(MlThreeJsLayer_MlThreeJsLayer,{init:function init(){var _loadingOverlayContex;return null==loadingOverlayContext||null===(_loadingOverlayContex=loadingOverlayContext.setControlled)||void 0===_loadingOverlayContex?void 0:_loadingOverlayContex.call(loadingOverlayContext,!0)},onDone:function onDone(){return setTimeout((function(){var _loadingOverlayContex2;return null==loadingOverlayContext||null===(_loadingOverlayContex2=loadingOverlayContext.setLoadingDone)||void 0===_loadingOverlayContex2?void 0:_loadingOverlayContex2.call(loadingOverlayContext,!0)}),1200)}}),react.createElement(TopToolbar.A,{unmovableButtons:react.createElement(react.Fragment,null,react.createElement(Button.A,{color:"primary",variant:showLayer?"contained":"outlined",onClick:function onClick(){setShowLayer(!showLayer),showLayerRef.current=!showLayer}},"3D model"))}),react.createElement(MlNavigationTools.A,{showFollowGpsButton:!1}))}.bind({});ExampleConfig.parameters={};const __namedExportsOrder=["ExampleConfig"];ExampleConfig.parameters={...ExampleConfig.parameters,docs:{...ExampleConfig.parameters?.docs,source:{originalSource:"() => {\n  const [showLayer, setShowLayer] = useState(true);\n  const showLayerRef = useRef(true);\n  const loadingOverlayContext = LoadingOverlayContext as {\n    setControlled?: (controlled: boolean) => void;\n    setLoadingDone?: (done: boolean) => void;\n  };\n  const mapHook = useMap();\n  mapHook.map?.setZoom(14.5);\n  mapHook.map?.setCenter([7.1, 50.736]);\n  return <>\n            {showLayer && <MlThreeJsLayer init={() => loadingOverlayContext?.setControlled?.(true)} onDone={() => setTimeout(() => loadingOverlayContext?.setLoadingDone?.(true), 1200)} /> as JSX.Element}\n\n            <TopToolbar unmovableButtons={<>\n                        <Button color=\"primary\" variant={showLayer ? 'contained' : 'outlined'} onClick={() => {\n        setShowLayer(!showLayer);\n        showLayerRef.current = !showLayer;\n      }}>\n                            3D model\n                        </Button>\n                    </>} />\n            <MlNavigationTools showFollowGpsButton={false} />\n        </>;\n}",...ExampleConfig.parameters?.docs?.source}}}},"./src/decorators/NoNavToolsDecorator.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),_index__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/index.ts"),_components_MapLibreMap_MapLibreMap__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/components/MapLibreMap/MapLibreMap.tsx"),_mui_material_styles__WEBPACK_IMPORTED_MODULE_5__=(__webpack_require__("./src/decorators/style.css"),__webpack_require__("./node_modules/@mui/material/esm/styles/ThemeProvider.js")),_ui_components_MapcomponentsTheme__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./src/ui_components/MapcomponentsTheme.tsx");const __WEBPACK_DEFAULT_EXPORT__=[function(Story,context){var _context$globals2,theme=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((function(){var _context$globals;return(0,_ui_components_MapcomponentsTheme__WEBPACK_IMPORTED_MODULE_4__.A)(null==context||null===(_context$globals=context.globals)||void 0===_context$globals?void 0:_context$globals.theme)}),[null==context||null===(_context$globals2=context.globals)||void 0===_context$globals2?void 0:_context$globals2.theme]);return react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",{className:"fullscreen_map"},react__WEBPACK_IMPORTED_MODULE_0__.createElement(_index__WEBPACK_IMPORTED_MODULE_1__.mO,null,react__WEBPACK_IMPORTED_MODULE_0__.createElement(_mui_material_styles__WEBPACK_IMPORTED_MODULE_5__.A,{theme},react__WEBPACK_IMPORTED_MODULE_0__.createElement(Story,null),react__WEBPACK_IMPORTED_MODULE_0__.createElement(_components_MapLibreMap_MapLibreMap__WEBPACK_IMPORTED_MODULE_2__.A,{options:{zoom:14.5,style:"https://wms.wheregroup.com/tileserver/style/osm-bright.json",center:[7.0851268,50.73884]},mapId:"map_1"}))))}]}}]);